{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Fix author username resolution and display across feed, comments, and group posts",
  "requirements": [
    {
      "id": "REQ-5",
      "summary": "Parse author principal text into a real Principal for profile lookups and gracefully handle invalid principal strings.",
      "acceptanceCriteria": [
        "`useGetUserProfile(user: string)` constructs a real Principal value from the provided text (e.g., via the Principal utility) before calling `actor.getUserProfile(...)`, rather than using an ad-hoc `{ toString: () => user } as any` object.",
        "When a valid profile exists for an author, `useGetUserProfile` returns it (not `null`) and UI components can display `profile.username`.",
        "If the input `user` string is invalid/unparseable, the query does not crash the app and returns `null` (so UI can use a fallback)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Update `useGetUserProfile(user: string)` to construct a real `Principal` from `user` (e.g., `Principal.fromText(user)`), call `actor.getUserProfile(principal)`, and wrap parsing/calls in try/catch so invalid/unparseable input returns `null` without crashing; keep query gated by actor availability and disable retries for parse/authorization failures."
        }
      ]
    },
    {
      "id": "REQ-6",
      "summary": "Show author username (from user profile) in the main plushie feed PostCard, with username-derived avatar initials and safe fallback.",
      "acceptanceCriteria": [
        "In `frontend/src/components/PostCard.tsx`, the author display name uses `useGetUserProfile(post.author.toString())` and shows `authorProfile.username` when available.",
        "In `frontend/src/components/PostCard.tsx`, the avatar fallback initials are derived from `authorProfile.username` when available, otherwise fall back to principal-derived initials.",
        "When no user profile exists for the author, the UI continues to show a safe fallback (e.g., truncated principal) without layout breakage."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/PostCard.tsx",
          "operation": "modify",
          "description": "Integrate `useGetUserProfile(post.author.toString())` and render `authorProfile.username` for the author name when available; update avatar fallback initials to prefer username-derived initials and otherwise fall back to principal-derived initials; preserve current truncated-principal fallback to avoid layout breakage."
        }
      ]
    },
    {
      "id": "REQ-7",
      "summary": "Show commenter/author username (from user profile) in comments and group post/comment UIs, matching existing Collection/Discussion behavior.",
      "acceptanceCriteria": [
        "In `frontend/src/components/CommentsSection.tsx`, each comment row resolves `comment.author` to a profile and displays `profile.username` when available (with a fallback if not).",
        "In `frontend/src/components/GroupPostCard.tsx`, the group post author name resolves to `profile.username` when available (with a fallback if not).",
        "In `frontend/src/components/GroupCommentsSection.tsx`, each group comment author name resolves to `profile.username` when available (with a fallback if not).",
        "All user-facing strings introduced/modified for this change are in English."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/CommentsSection.tsx",
          "operation": "modify",
          "description": "Refactor comment row rendering to avoid calling hooks inside a map (e.g., introduce a `CommentItem` child component) and use `useGetUserProfile(comment.author.toString())` to display `profile.username` and username-derived avatar initials when available, with truncated-principal fallback when not."
        },
        {
          "path": "frontend/src/components/GroupPostCard.tsx",
          "operation": "modify",
          "description": "Add `useGetUserProfile(post.author.toString())` and display `profile.username` for the group post author when available; update avatar fallback initials to prefer username-derived initials, otherwise keep the principal-based fallback."
        },
        {
          "path": "frontend/src/components/GroupCommentsSection.tsx",
          "operation": "modify",
          "description": "Refactor group comment row rendering to avoid calling hooks inside a map (e.g., introduce a `GroupCommentItem` child component) and use `useGetUserProfile(comment.author.toString())` to display `profile.username` and username-derived avatar initials when available, with truncated-principal fallback when not."
        }
      ]
    }
  ]
}